<html>

<head>
    <script src="bundle.js"></script>
    <script>
        function doit() {
            var blocktrail = window.blocktrail;

            blocktrail.debug.enable('*');

            var client = blocktrail.BlocktrailSDK({
                apiKey: "MY_APIKEY",
                apiSecret: "MY_APISECRET",
                testnet: true
            });

            var sendTransaction = function(wallet) {
                wallet.getNewAddress(function(err, address, path) {
                    if (err) {
                        return console.log("getNewAddress ERR", err);
                    }

                    console.log('new address', address, path);

                    var pay = {};
                    pay[address] = blocktrail.toSatoshi(0.001);

                    wallet.pay(pay, function(err, result) {
                        if (err) {
                            return console.log("pay ERR", err);
                        }

                        console.log('transaction', result);
                    });
                });
            };

            var action = 'default';

            if (action === 'create') {
                client.createNewWallet({
                    identifier: "example-wallet",
                    passphrase: "example-strong-password",
                    keyIndex: 9999
                }, function(err, wallet, primaryMnemonic, backupMnemonic, blocktrailPubKeys) {
                    if (err) {
                        return console.log("createNewWallet ERR", err);
                    }

                    console.log('primary mnemonic', primaryMnemonic);
                    console.log('backup mnemonic', backupMnemonic);
                    console.log('blocktrail pubkeys', blocktrailPubKeys);

                    wallet.doDiscovery(function(err, confirmed, unconfirmed) {
                        if (err) {
                            return console.log("doDiscovery ERR", err);
                        }

                        console.log('confirmed balance', confirmed);
                        console.log('unconfirmed balance', unconfirmed);

                        sendTransaction(wallet);
                    });
                });
            } else {
                client.initWallet({
                    identifier: "example-wallet",
                    passphrase: "example-strong-password"
                }, function(err, wallet) {
                    if (err) {
                        console.log('initWallet ERR');
                        console.log(err);
                        return;
                    }

                    window.wallet = wallet;

                    wallet.getBalance(function(err, confirmed, unconfirmed) {
                        if (err) {
                            return console.log("getBalance ERR", err);
                        }

                        console.log('confirmed balance', confirmed);
                        console.log('unconfirmed balance', unconfirmed);

                        sendTransaction(wallet);
                    });
                });
            }
        }
    </script>
</head>
<body>
    <button onclick="doit()">init wallet</button>
</body>
</html>
